<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>باحث الريموت الذكي</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- خط Inter (خط عصري ونظيف) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- CSS مخصص لتأثيرات النيون الذهبي -->
    <style>
        :root {
            --neon-gold: #FFD700; /* لون ذهبي أساسي */
            --glow-gold: #ffc300; /* لون التوهج */
            --dark-bg: #0a0a0a;   /* خلفية سوداء داكنة جداً */
            --input-bg: #1a1a1a;  /* خلفية حقول الإدخال */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--neon-gold);
        }

        /* حاوية النموذج الرئيسية مع الإطار المتوهج */
        .neon-glow-border {
            border: 2px solid var(--neon-gold);
            border-radius: 0.75rem; /* 12px */
            /* الظل المتوهج المتعدد لإنشاء تأثير النيون */
            box-shadow: 0 0 5px var(--glow-gold),
                        0 0 10px var(--glow-gold),
                        0 0 20px var(--glow-gold),
                        0 0 30px rgba(255, 195, 0, 0.5);
            transition: all 0.3s ease-in-out;
        }
        
        /* تأثير عند مرور الماوس على الحاوية (اختياري) */
        .neon-glow-border:hover {
            box-shadow: 0 0 10px var(--glow-gold),
                        0 0 20px var(--glow-gold),
                        0 0 35px var(--glow-gold),
                        0 0 50px rgba(255, 195, 0, 0.7);
        }

        /* تنسيق حقول الإدخال والقائمة المنسدلة */
        .neon-input {
            background-color: var(--input-bg);
            border: 1px solid var(--neon-gold);
            color: var(--neon-gold);
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 0 3px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .neon-input::placeholder {
            color: #bdae00;
            opacity: 0.6;
        }

        /* توهج عند التركيز على الحقل */
        .neon-input:focus {
            outline: none;
            border-color: var(--glow-gold);
            box-shadow: 0 0 8px var(--glow-gold);
        }
        
        /* تنسيق الخيارات داخل القائمة المنسدلة */
        .neon-input option {
            background-color: var(--input-bg);
            color: var(--neon-gold);
        }

        /* تنسيق الزر المتوهج */
        .neon-button {
            background-color: var(--neon-gold);
            color: var(--dark-bg);
            font-weight: 700;
            border: 2px solid var(--neon-gold);
            border-radius: 0.5rem;
            box-shadow: 0 0 5px var(--glow-gold),
                        0 0 10px var(--glow-gold);
            transition: all 0.3s ease;
        }

        /* تأثير النيون عند مرور الماوس على الزر */
        .neon-button:hover {
            background-color: var(--dark-bg);
            color: var(--neon-gold);
            box-shadow: 0 0 10px var(--glow-gold),
                        0 0 20px var(--glow-gold),
                        0 0 30px var(--glow-gold);
        }
        
        /* تنسيق منطقة النتائج */
        #result-box {
            border: 1px dashed var(--neon-gold);
            background-color: var(--input-bg);
            color: #ffffff; /* لون أبيض للنتيجة لتكون واضحة */
            opacity: 0;
            transition: opacity 0.5s ease;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- حاوية التطبيق الرئيسية -->
    <div class="w-full max-w-md p-6 md:p-8 neon-glow-border">
        
        <h1 class="text-3xl font-bold text-center mb-6" style="text-shadow: 0 0 5px var(--glow-gold);">
            باحث الريموت الذكي
        </h1>

        <form id="ai-form" class="space-y-5">
            
            <!-- الحقل الأول: السنه -->
            <div>
                <label for="year" class="block text-sm font-medium mb-1">السنه</label>
                <input type="number" id="year" name="year" class="w-full p-3 neon-input" placeholder="مثال: 2024" required>
            </div>
            
            <!-- الحقل الثاني: النوع -->
            <div>
                <label for="type" class="block text-sm font-medium mb-1">النوع</label>
                <input type="text" id="type" name="type" class="w-full p-3 neon-input" placeholder="مثال: سيدان" required>
            </div>

            <!-- الحقل الثالث: الطراز -->
            <div>
                <label for="model" class="block text-sm font-medium mb-1">الطراز</label>
                <input type="text" id="model" name="model" class="w-full p-3 neon-input" placeholder="مثال: كامري" required>
            </div>

            <!-- الحقل الرابع: السوق (قائمة منسدلة) -->
            <div>
                <label for="market" class="block text-sm font-medium mb-1">السوق</label>
                <select id="market" name="market" class="w-full p-3 neon-input" required>
                    <option value="" disabled selected>اختر السوق...</option>
                    <option value="american">السوق الامريكي</option>
                    <option value="european">السوق الاوربي</option>
                    <option value="global">السوق العالمي</option>
                </select>
            </div>
            
            <!-- زر التشغيل -->
            <div>
                <button type="submit" class="w-full py-3 mt-4 neon-button">
                    بحث
                </button>
            </div>
        </form>
        
        <!-- منطقة عرض النتائج -->
        <div id="result-box" class="mt-6 p-4 rounded-md text-right">
            <p id="result-text">...</p>
        </div>

    </div>

    <script>
        const form = document.getElementById('ai-form');
        const resultBox = document.getElementById('result-box');
        const resultText = document.getElementById('result-text');

        // *** معالج حدث إرسال النموذج ***
        form.addEventListener('submit', async function(event) {
            // منع الإرسال الفعلي للنموذج
            event.preventDefault(); 
            
            // الحصول على القيم المدخلة
            const year = document.getElementById('year').value;
            const type = document.getElementById('type').value;
            const model = document.getElementById('model').value;
            const market = document.getElementById('market').value;

            // إظهار رسالة "جاري البحث"
            resultBox.style.opacity = '1';
            resultText.style.color = 'var(--neon-gold)'; // لون ذهبي لرسالة الانتظار
            resultText.textContent = 'جاري البحث عن بيانات الريموت المطابق...';

            // *** استدعاء الـ API الحقيقي ***
            await callGeminiAPI(year, type, model, market);
        });

        // *** دالة لاستدعاء Gemini API ***
        async function callGeminiAPI(year, type, model, market) {
            const apiKey = ""; // سيتم توفير المفتاح تلقائيًا
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // 2. إعداد نص البحث (الـ Prompt) - بتنسيق لسهولة التحليل
            const userQuery = `ابحث عن بيانات الريموت لسيارة:
- الطراز: ${model}
- النوع: ${type}
- السنة: ${year}
- السوق: ${market}

ابحث عن FCC ID و Part Number ونوع الريموت.
ابحث أيضًا عن 2-3 احتمالات أو بدائل شائعة.

---
الرجاء تنسيق الرد **فقط** بالشكل التالي (لا تضف أي نص إضافي):
FCC_ID: [البيانات أو "غير متوفر"]
PART_NUMBER: [البيانات أو "غير متوفر"]
REMOTE_TYPE: [البيانات أو "غير متوفر"]
ALT_1_FCC: [بيانات البديل 1 أو "N/A"]
ALT_1_PN: [بيانات البديل 1 أو "N/A"]
ALT_1_NOTES: [ملاحظات 1 أو "N/A"]
ALT_2_FCC: [بيانات البديل 2 أو "N/A"]
ALT_2_PN: [بيانات البديل 2 أو "N/A"]
ALT_2_NOTES: [ملاحظات 2 أو "N/A"]
`;

            // 3. إعداد حمولة الطلب (Payload)
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // تعليمات للنظام لضمان الدقة
                systemInstruction: {
                    parts: [{ text: "أنت مساعد خبير في قطع غيار السيارات، متخصص في ريموتات المفاتيح. ابحث عن المعلومات المطلوبة بدقة والتزم **تماماً** بالتنسيق المطلوب في نهاية طلب المستخدم. لا تضف أي مقدمات أو خواتيم." }]
                },
                // *** تفعيل البحث المباشر (Google Search Grounding) ***
                tools: [{ "google_search": {} }]
            };

            // 4. إرسال الطلب مع معالجة الأخطاء
            try {
                // استخدام الدالة الجديدة التي تتضمن إعادة المحاولة
                const result = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // استخراج النص الخام من الاستجابة
                const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawText) {
                    throw new Error("لم يتم العثور على محتوى في استجابة الـ API.");
                }

                // عرض النتائج
                displayResults(rawText, model, year);

            } catch (error) {
                // في حالة الفشل النهائي
                resultText.style.color = '#ff4d4d'; // لون أحمر للخطأ
                resultText.textContent = 'حدث خطأ أثناء البحث. الرجاء المحاولة مرة أخرى لاحقاً.';
            }
        }

        // *** دالة لعرض النتائج الحقيقية (تحليل النص) ***
        function displayResults(rawText, model, year) {
            
            // دالة مساعدة لاستخراج البيانات باستخدام Regex
            const extract = (key) => {
                // 'im' = غير حساس لحالة الأحرف، ومتعدد الأسطر
                const regex = new RegExp(`^${key}: (.*)`, "im"); 
                const match = rawText.match(regex);
                // إرجاع القيمة أو null إذا لم يُعثر عليها
                return match && match[1] ? match[1].trim() : null; 
            };

            // استخراج البيانات الرئيسية
            const fccId = extract("FCC_ID") || "غير متوفر";
            const partNumber = extract("PART_NUMBER") || "غير متوفر";
            const remoteType = extract("REMOTE_TYPE") || "غير متوفر";

            // بناء قائمة البدائل
            let alternatives = [];
            for (let i = 1; i <= 3; i++) { // البحث عن 3 بدائل
                const altFcc = extract(`ALT_${i}_FCC`);
                const altPn = extract(`ALT_${i}_PN`);
                const altNotes = extract(`ALT_${i}_NOTES`);
                
                // إضافة البديل فقط إذا تم العثور على FCC ID أو Part Number
                // والتأكد من أنها ليست القيمة الافتراضD "N/A"
                if ((altFcc && altFcc !== "N/A") || (altPn && altPn !== "N/A")) {
                    alternatives.push({
                        fccId: (altFcc && altFcc !== "N/A") ? altFcc : "N/A",
                        partNumber: (altPn && altPn !== "N/A") ? altPn : "N/A",
                        notes: (altNotes && altNotes !== "N/A") ? altNotes : "ملاحظة"
                    });
                }
            }

            // بناء HTML للبدائل
            let alternativesHtml = '';
            if (alternatives.length > 0) {
                alternativesHtml = alternatives.map(alt => 
                    `<li>FCC: ${alt.fccId}, P/N: ${alt.partNumber} (${alt.notes})</li>`
                ).join('');
            } else {
                alternativesHtml = '<li>لا توجد بدائل شائعة مسجلة.</li>';
            }

            // تحديث واجهة المستخدم بالنتائج
            resultText.style.color = '#ffffff'; // إرجاع اللون للأبيض
            resultText.innerHTML = `
                <strong class="block text-lg mb-2">النتائج لـ (${model} ${year}):</strong>
                <div class="space-y-1">
                    <p><strong class="text-gray-400">FCC ID:</strong> ${fccId}</p>
                    <p><strong class="text-gray-400">Part Number:</strong> ${partNumber}</p>
                    <p><strong class="text-gray-400">النوع:</strong> ${remoteType}</p>
                </div>
                <hr class="my-3 border-gray-600">
                <strong class="block text-lg mt-2" style="color: var(--neon-gold);">احتمالات اخرى تتطابق:</strong>
                <ul class="list-disc list-outside mr-5 mt-2 space-y-1 text-sm">
                    ${alternativesHtml}
                </ul>
            `;
        }

        // *** دالة مساعدة لإعادة المحاولة عند فشل الطلب (Exponential Backoff) ***
        async function fetchWithRetry(url, options, maxRetries = 3, initialDelay = 1000) {
            let delay = initialDelay;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    // نجح الطلب
                    if (response.ok) {
                        return response.json();
                    }
                    // فشل بسبب خطأ من الخادم أو ضغط (Rate Limit)
                    if (response.status === 429 || response.status >= 500) {
                         // انتظر قبل إعادة المحاولة
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // مضاعفة وقت الانتظار
                    } else {
                        // خطأ من العميل (مثل 400)، لا داعي لإعادة المحاولة
                        throw new Error(`Client Error: ${response.status}`);
                    }
                } catch (error) {
                    // فشل في الشبكة
                    if (i === maxRetries - 1) throw error; // إطلاق الخطأ بعد آخر محاولة
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            // فشل بعد كل المحاولات
            throw new Error("فشل الاتصال بالـ API بعد عدة محاولات.");
        }

    </script>

</body>
</html>


